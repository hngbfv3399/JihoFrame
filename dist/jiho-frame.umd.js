(function(p,y){typeof exports=="object"&&typeof module<"u"?y(exports):typeof define=="function"&&define.amd?define(["exports"],y):(p=typeof globalThis<"u"?globalThis:p||self,y(p.JihoFrame={}))})(this,function(p){"use strict";let y={},U={},k=[],j=new WeakMap,E=new Set,x=!1,J=[],_=[],C=new Map,N=[];function M(){if(x)return;x=!0;const e=Array.from(E);E.clear(),[...new Set(e)].forEach(c=>{try{c()}catch(r){console.error("JihoFrame: 업데이트 중 오류 발생:",r)}}),x=!1}function O(){E.size>0&&Promise.resolve().then(M)}function T(e){if(typeof e!="function"){console.warn("JihoFrame: jihoInit expects a function");return}J.push(e)}function B(e){if(typeof e!="function"){console.warn("JihoFrame: jihoMount expects a function");return}_.push(e)}function I(e,t){if(typeof e!="function"){console.warn("JihoFrame: jihoUpdate expects a function as first parameter");return}C.has(t)||C.set(t,[]),C.get(t).push(e)}function L(e){if(typeof e!="function"){console.warn("JihoFrame: jihoUnMount expects a function");return}N.push(e)}function V(e,t){if(typeof e!="string")throw new Error("JihoFrame: State key must be a string");e in y||(y[e]=t,U[e]=new Set);const c={get value(){return y[e]},set value(r){y[e]!==r&&(y[e]=r,k.forEach(n=>E.add(n)),C.has(c)&&C.get(c).forEach(n=>E.add(n)),U[e].forEach(n=>E.add(n)),O())},get:()=>y[e],set:r=>{c.value=r},subscribe:(r,n=null)=>{if(typeof r!="function")return console.warn("JihoFrame: subscribe expects a function"),()=>{};U[e].add(r);const o=()=>U[e].delete(r);return n&&(j.has(n)||j.set(n,[]),j.get(n).push(o)),o}};return c.get._setter=c.set,c}function v(e,t=null){if(typeof e!="function")return console.warn("JihoFrame: subscribeState expects a function"),()=>{};k.push(e);const c=()=>{const r=k.indexOf(e);r>-1&&k.splice(r,1)};return t&&(j.has(t)||j.set(t,[]),j.get(t).push(c)),c}function f(e,t="Unknown"){var c;console.error(`JihoFrame Error in ${t}:`,e),((c=process==null?void 0:process.env)==null?void 0:c.NODE_ENV)==="development"&&console.trace()}function h(e,t="function",c=null){try{return e()}catch(r){return f(r,t),c}}function S(e,t,c){return t==="function"&&typeof e!="function"?(console.warn(`JihoFrame: Expected function in ${c}, got ${typeof e}`),!1):!0}function g(e,t,c="text"){if(typeof t=="function"){const r=()=>{const o=h(t,"bindValue update");o!==null&&(c==="checkbox"?e.checked=!!o:c==="radio"?e.checked=e.value===o:e.value=o)};r();const n=v(r);e._jihoUnsubscribers?e._jihoUnsubscribers.push(n):e._jihoUnsubscribers=[n],e.addEventListener("input",o=>{if(t._setter)try{c==="checkbox"?t._setter(o.target.checked):c==="radio"?o.target.checked&&t._setter(o.target.value):t._setter(o.target.value)}catch(s){f(s,"input event handler")}})}else c==="checkbox"?e.checked=!!t:c==="radio"?e.checked=e.value===t:e.value=t}function q(e,t,c){if(!t||typeof t!="object"){console.warn("JihoFrame: Invalid options passed to applyAttributes");return}const{text:r,style:n,id:o,className:s,event:u}=t;if(typeof r=="function"){const a=()=>{const l=h(r,"text update");l!==null&&(e.textContent=l)};a();const i=v(a);e._jihoUnsubscribers?e._jihoUnsubscribers.push(i):e._jihoUnsubscribers=[i]}else r!==void 0&&(e.textContent=r);if(n&&typeof n=="object")try{Object.assign(e.style,n)}catch(a){f(a,"style application")}if(o&&(e.id=o),s&&(e.className=s),Array.isArray(u))u.forEach(a=>{if(typeof a!="object"){console.warn("JihoFrame: Event object must be an object");return}for(const[i,l]of Object.entries(a)){if(!S(l,"function",`event ${i}`))continue;const b=i.toLowerCase().replace(/^on/,"");e.addEventListener(b,w=>{h(()=>l(w),`event handler ${i}`)})}});else if(u&&typeof u=="object")for(const[a,i]of Object.entries(u)){if(!S(i,"function",`event ${a}`))continue;const l=a.toLowerCase().replace(/^on/,"");e.addEventListener(l,b=>{h(()=>i(b),`event handler ${a}`)})}const d=a=>{a.forEach(i=>{if(i in t)try{e[i]=t[i]}catch(l){f(l,`setting attribute ${i}`)}})};switch(c){case"input":d(["type","checked","multiple","placeholder","required","name"]);const a=t.type||"text";g(e,t.value,a);break;case"textarea":d(["placeholder","required","rows","cols"]),g(e,t.value);break;case"select":d(["multiple","required","name"]),Array.isArray(t.options)&&t.options.forEach(i=>{const l=document.createElement("option");typeof i=="string"?(l.value=i,l.textContent=i):i&&typeof i=="object"&&(l.value=i.value||"",l.textContent=i.label||i.value||""),e.appendChild(l)}),g(e,t.value);break;case"checkbox":g(e,t.value,"checkbox");break;case"radio":g(e,t.value,"radio");break}if(typeof t.disabled=="function"){const a=()=>{const l=h(t.disabled,"disabled update");l!==null&&(e.disabled=!!l)};a();const i=v(a);e._jihoUnsubscribers?e._jihoUnsubscribers.push(i):e._jihoUnsubscribers=[i]}else t.disabled!==void 0&&(e.disabled=!!t.disabled);if(typeof t.show=="function"){const a=()=>{const l=h(t.show,"show update");l!==null&&(e.style.display=l?"":"none")};a();const i=v(a);e._jihoUnsubscribers?e._jihoUnsubscribers.push(i):e._jihoUnsubscribers=[i]}else t.show===!1&&(e.style.display="none")}function D(e,t){var r;if(!t||typeof t!="object")return;const c=new Set(["text","style","id","className","event","children","if","elseIf","else","switch","case","default","option","type","value","checked","multiple","placeholder","required","for","each","show","disabled"]);if(Object.entries(t).forEach(([n,o])=>{if(!c.has(n))try{const s=typeof o=="function"?h(o,`child component ${n}`):o;if(!s)return;const[u,d]=Object.entries(s)[0],a=m(u,d);a&&e.appendChild(a)}catch(s){f(s,`rendering child ${n}`)}}),Array.isArray(t.children)&&t.children.forEach((n,o)=>{try{if(!n||typeof n!="object"){console.warn(`JihoFrame: Invalid child at index ${o}`);return}const[s,u]=Object.entries(n)[0],d=m(s,u);d&&e.appendChild(d)}catch(s){f(s,`rendering child at index ${o}`)}}),(r=t.each)!=null&&r.list)try{const n=typeof t.each.list=="function"?h(t.each.list,"each list function"):t.each.list;Array.isArray(n)&&typeof t.each.render=="function"&&n.forEach((o,s)=>{try{const u=h(()=>t.each.render(o,s),`each render at index ${s}`);if(u){const[d,a]=Object.entries(u)[0],i=m(d,a);i&&e.appendChild(i)}}catch(u){f(u,`each item rendering at index ${s}`)}})}catch(n){f(n,"each list processing")}}function F(e){e._jihoUnsubscribers&&(e._jihoUnsubscribers.forEach(t=>{try{t()}catch(c){f(c,"cleanup unsubscribe")}}),delete e._jihoUnsubscribers),Array.from(e.children).forEach(t=>F(t))}function m(e,t){try{if(typeof e=="function"){const r=h(()=>e(t),`component ${e.name||"anonymous"}`);if(!r)return null;if(r.nodeType)return r;if(r.layout){const s=document.createElement("div");return s.style.display="contents",new $(s).update(r.layout),s}const[n,o]=Object.entries(r)[0];return m(n,o)}if(typeof t=="function"){const r=h(t,"options function");if(!r)return null;const[n,o]=Object.entries(r)[0];return m(n,o)}if(typeof t=="string"){const r=document.createElement(e);return r.textContent=t,r}if(typeof e!="string")return console.warn("JihoFrame: Tag must be a string, got:",typeof e),null;const c=document.createElement(e);return t&&(q(c,t,e),D(c,t)),c}catch(c){return f(c,`createElement for tag ${e}`),null}}function P(e,t){if(!Array.isArray(e)){console.warn("JihoFrame: Conditional block value must be an array");return}let c=document.createComment("condition-start"),r=document.createComment("condition-end"),n=null,o=[];t.appendChild(c),t.appendChild(r);const s=()=>{n&&(F(n),n.parentNode&&n.parentNode.removeChild(n),n=null),o.forEach(a=>{try{a()}catch(i){f(i,"conditional cleanup unsubscribe")}}),o=[]},u=()=>{try{t.contains(r)||(r=document.createComment("condition-end"),t.appendChild(r)),s();let a=!1;for(const i of e){if(!i||typeof i!="object"){console.warn("JihoFrame: Invalid conditional item");continue}const[l,b]=Object.entries(i)[0];if(!b||typeof b!="object")continue;const w=b.if??(a?!1:b.elseIf??b.else);if((typeof w=="function"?h(w,"conditional condition"):w)&&!a){const A=m(l,b);if(A&&t.contains(r)){t.insertBefore(A,r),n=A,a=!0;break}}}}catch(a){f(a,"conditional block rerender")}},d=v(u);return o.push(d),u(),s}function R(e,t){if(!e||typeof e!="object"){console.warn("JihoFrame: Switch block must be an object");return}let c=document.createComment("switch-start"),r=document.createComment("switch-end"),n=null,o=[];t.appendChild(c),t.appendChild(r);const s=()=>{n&&(F(n),n.parentNode&&n.parentNode.removeChild(n),n=null),o.forEach(a=>{try{a()}catch(i){f(i,"switch cleanup unsubscribe")}}),o=[]},u=()=>{try{t.contains(r)||(r=document.createComment("switch-end"),t.appendChild(r)),s();const a=typeof e.switch=="function"?h(e.switch,"switch value function"):e.switch;if(!Array.isArray(e.cases)){console.warn("JihoFrame: Switch cases must be an array");return}for(const i of e.cases)if(!(!i||typeof i!="object")&&(i.case===a||i.default===!0)&&i.element&&typeof i.element=="object"){const[l,b]=Object.entries(i.element)[0],w=m(l,b);if(w&&t.contains(r)){t.insertBefore(w,r),n=w;break}}}catch(a){f(a,"switch block rerender")}},d=v(u);return o.push(d),u(),s}class ${constructor(t){this.container=t,this.currentNodes=[],this.cleanupFunctions=[]}cleanup(){this.currentNodes.forEach(t=>{t&&t.parentNode&&(F(t),t.parentNode.removeChild(t))}),this.cleanupFunctions.forEach(t=>{try{t()}catch(c){f(c,"DOM updater cleanup")}}),this.currentNodes=[],this.cleanupFunctions=[]}update(t){if(this.cleanup(),!Array.isArray(t)){console.warn("JihoFrame: Layout must be an array");return}t.forEach((c,r)=>{try{if(typeof c=="function"){const n=h(c,`layout function at index ${r}`);if(n){const[o,s]=Object.entries(n)[0],u=m(o,s);u&&(this.container.appendChild(u),this.currentNodes.push(u))}}else if(c&&typeof c=="object"){const[n,o]=Object.entries(c)[0];if(n==="condition"&&Array.isArray(o)){const s=P(o,this.container);s&&this.cleanupFunctions.push(s)}else if(n==="switchBlock"){const s=R(o,this.container);s&&this.cleanupFunctions.push(s)}else{const s=m(n,o);s&&(this.container.appendChild(s),this.currentNodes.push(s))}}}catch(n){f(n,`rendering layout item at index ${r}`)}})}}function z(e,t){if(typeof e!="function")throw new Error("JihoFrame: App must be a function");if(!t||!t.appendChild)throw new Error("JihoFrame: Container must be a valid DOM element");J.forEach(u=>{try{u()}catch(d){f(d,"init callback")}});const c=new $(t);let r=[];const n=()=>{try{const u=h(e,"app function");if(!u)return;if(!u.layout){console.warn("JihoFrame: App function must return an object with layout property");return}c.update(u.layout),_.forEach(d=>{try{d()}catch(a){f(a,"mount callback")}})}catch(u){f(u,"app rerender")}},o=v(n);r.push(o),n();const s=()=>{try{N.forEach(u=>{try{u()}catch(d){f(d,"unmount callback")}}),c.cleanup(),r.forEach(u=>{try{u()}catch(d){f(d,"app unsubscribe")}})}catch(u){f(u,"app cleanup")}};return window.addEventListener("beforeunload",s),s}p.createState=V,p.jihoInit=T,p.jihoMount=B,p.jihoUnMount=L,p.jihoUpdate=I,p.renderApp=z,p.subscribeState=v,Object.defineProperty(p,Symbol.toStringTag,{value:"Module"})});
