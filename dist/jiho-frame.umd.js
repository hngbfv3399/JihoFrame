(function(h,p){typeof exports=="object"&&typeof module<"u"?p(exports):typeof define=="function"&&define.amd?define(["exports"],p):(h=typeof globalThis<"u"?globalThis:h||self,p(h.JihoFrame={}))})(this,function(h){"use strict";let p={},y={},F=[],w=new WeakMap,C=new Set,A=!1,k=[],x=[],S=new Map,_=[];function B(){if(A)return;A=!0;const e=Array.from(C);C.clear(),[...new Set(e)].forEach(r=>{try{r()}catch(n){console.error("JihoFrame: 업데이트 중 오류 발생:",n)}}),A=!1}function I(){C.size>0&&Promise.resolve().then(B)}function V(e){if(typeof e!="function"){console.warn("JihoFrame: jihoInit expects a function");return}k.push(e)}function D(e){if(typeof e!="function"){console.warn("JihoFrame: jihoMount expects a function");return}x.push(e)}function L(e,t){if(typeof e!="function"){console.warn("JihoFrame: jihoUpdate expects a function as first parameter");return}S.has(t)||S.set(t,[]),S.get(t).push(e)}function q(e){if(typeof e!="function"){console.warn("JihoFrame: jihoUnMount expects a function");return}_.push(e)}function K(e){w.has(e)&&(w.get(e).forEach(r=>r()),w.delete(e))}function $(e,t){if(typeof e!="string")throw new Error("JihoFrame: State key must be a string");e in p||(p[e]=t,y[e]=new Set);const r={get value(){return p[e]},set value(n){p[e]!==n&&(p[e]=n,F.forEach(c=>C.add(c)),S.has(r)&&S.get(r).forEach(c=>C.add(c)),y[e].forEach(c=>C.add(c)),I())},get:()=>p[e],set:n=>{r.value=n},subscribe:(n,c=null)=>{if(typeof n!="function")return console.warn("JihoFrame: subscribe expects a function"),()=>{};y[e].add(n);const o=()=>y[e].delete(n);return c&&(w.has(c)||w.set(c,[]),w.get(c).push(o)),o}};return r.get._setter=r.set,r}function j(e,t=null){if(typeof e!="function")return console.warn("JihoFrame: subscribeState expects a function"),()=>{};F.push(e);const r=()=>{const n=F.indexOf(e);n>-1&&F.splice(n,1)};return t&&(w.has(t)||w.set(t,[]),w.get(t).push(r)),r}function P(){return{...p}}function N(e){e?(delete p[e],y[e]&&y[e].clear()):(p={},Object.values(y).forEach(t=>t.clear()),y={})}function R(e,t){if(typeof t!="function")return console.warn("JihoFrame: watchState callback must be a function"),()=>{};if(!y[e])return console.warn(`JihoFrame: State key "${e}" does not exist`),()=>{};const r=(n,c)=>{try{t(n,c,e)}catch(o){Q(o,`watchState callback for ${e}`)}};return y[e].add(r),()=>y[e].delete(r)}function M(e,t){if(!Array.isArray(e))throw new Error("JihoFrame: combineStates expects an array of state objects");if(typeof t!="function")throw new Error("JihoFrame: combineStates expects a combiner function");const r=`combined_${Date.now()}_${Math.random()}`,n=()=>{const i=e.map(l=>l.value),s=t(...i);p[r]!==s&&(p[r]=s)};n();const c=e.map(i=>i.subscribe(n)),o=$(r,p[r]);return o.cleanup=()=>{c.forEach(i=>i()),N(r)},o}function z(e,t){if(!Array.isArray(e))throw new Error("JihoFrame: computedState expects an array of dependencies");if(typeof t!="function")throw new Error("JihoFrame: computedState expects a computer function");return M(e,t)}function Q(e,t="Unknown"){var r,n;console.error(`JihoFrame Error in ${t}:`,e),typeof window<"u"&&((n=(r=window.process)==null?void 0:r.env)==null?void 0:n.NODE_ENV)==="development"&&console.trace()}function d(e,t="Unknown"){var r;console.error(`JihoFrame Error in ${t}:`,e),((r=process==null?void 0:process.env)==null?void 0:r.NODE_ENV)==="development"&&console.trace()}function b(e,t="function",r=null){try{return e()}catch(n){return d(n,t),r}}function O(e,t,r){return t==="function"&&typeof e!="function"?(console.warn(`JihoFrame: Expected function in ${r}, got ${typeof e}`),!1):!0}function g(e,t,r="text"){if(typeof t=="function"){const n=()=>{const o=b(t,"bindValue update");o!==null&&(r==="checkbox"?e.checked=!!o:r==="radio"?e.checked=e.value===o:e.value=o)};n();const c=j(n);e._jihoUnsubscribers?e._jihoUnsubscribers.push(c):e._jihoUnsubscribers=[c],e.addEventListener("input",o=>{if(t._setter)try{r==="checkbox"?t._setter(o.target.checked):r==="radio"?o.target.checked&&t._setter(o.target.value):t._setter(o.target.value)}catch(i){d(i,"input event handler")}})}else r==="checkbox"?e.checked=!!t:r==="radio"?e.checked=e.value===t:e.value=t}function W(e,t,r){if(!t||typeof t!="object"){console.warn("JihoFrame: Invalid options passed to applyAttributes");return}const{text:n,style:c,id:o,className:i,event:s}=t;if(typeof n=="function"){const u=()=>{const f=b(n,"text update");f!==null&&(e.textContent=f)};u();const a=j(u);e._jihoUnsubscribers?e._jihoUnsubscribers.push(a):e._jihoUnsubscribers=[a]}else n!==void 0&&(e.textContent=n);if(c&&typeof c=="object")try{Object.assign(e.style,c)}catch(u){d(u,"style application")}if(o&&(e.id=o),i&&(e.className=i),Array.isArray(s))s.forEach(u=>{if(typeof u!="object"){console.warn("JihoFrame: Event object must be an object");return}for(const[a,f]of Object.entries(u)){if(!O(f,"function",`event ${a}`))continue;const m=a.toLowerCase().replace(/^on/,"");e.addEventListener(m,v=>{b(()=>f(v),`event handler ${a}`)})}});else if(s&&typeof s=="object")for(const[u,a]of Object.entries(s)){if(!O(a,"function",`event ${u}`))continue;const f=u.toLowerCase().replace(/^on/,"");e.addEventListener(f,m=>{b(()=>a(m),`event handler ${u}`)})}const l=u=>{u.forEach(a=>{if(a in t)try{e[a]=t[a]}catch(f){d(f,`setting attribute ${a}`)}})};switch(r){case"input":l(["type","checked","multiple","placeholder","required","name"]);const u=t.type||"text";g(e,t.value,u);break;case"textarea":l(["placeholder","required","rows","cols"]),g(e,t.value);break;case"select":l(["multiple","required","name"]),Array.isArray(t.options)&&t.options.forEach(a=>{const f=document.createElement("option");typeof a=="string"?(f.value=a,f.textContent=a):a&&typeof a=="object"&&(f.value=a.value||"",f.textContent=a.label||a.value||""),e.appendChild(f)}),g(e,t.value);break;case"checkbox":g(e,t.value,"checkbox");break;case"radio":g(e,t.value,"radio");break}if(typeof t.disabled=="function"){const u=()=>{const f=b(t.disabled,"disabled update");f!==null&&(e.disabled=!!f)};u();const a=j(u);e._jihoUnsubscribers?e._jihoUnsubscribers.push(a):e._jihoUnsubscribers=[a]}else t.disabled!==void 0&&(e.disabled=!!t.disabled);if(typeof t.show=="function"){const u=()=>{const f=b(t.show,"show update");f!==null&&(e.style.display=f?"":"none")};u();const a=j(u);e._jihoUnsubscribers?e._jihoUnsubscribers.push(a):e._jihoUnsubscribers=[a]}else t.show===!1&&(e.style.display="none")}function G(e,t){var n;if(!t||typeof t!="object")return;const r=new Set(["text","style","id","className","event","children","if","elseIf","else","switch","case","default","option","type","value","checked","multiple","placeholder","required","for","each","show","disabled"]);if(Object.entries(t).forEach(([c,o])=>{if(!r.has(c))try{const i=typeof o=="function"?b(o,`child component ${c}`):o;if(!i)return;const[s,l]=Object.entries(i)[0],u=E(s,l);u&&e.appendChild(u)}catch(i){d(i,`rendering child ${c}`)}}),Array.isArray(t.children)&&t.children.forEach((c,o)=>{try{if(!c||typeof c!="object"){console.warn(`JihoFrame: Invalid child at index ${o}`);return}const[i,s]=Object.entries(c)[0],l=E(i,s);l&&e.appendChild(l)}catch(i){d(i,`rendering child at index ${o}`)}}),(n=t.each)!=null&&n.list)try{const c=typeof t.each.list=="function"?b(t.each.list,"each list function"):t.each.list;Array.isArray(c)&&typeof t.each.render=="function"&&c.forEach((o,i)=>{try{const s=b(()=>t.each.render(o,i),`each render at index ${i}`);if(s){const[l,u]=Object.entries(s)[0],a=E(l,u);a&&e.appendChild(a)}}catch(s){d(s,`each item rendering at index ${i}`)}})}catch(c){d(c,"each list processing")}}function U(e){e._jihoUnsubscribers&&(e._jihoUnsubscribers.forEach(t=>{try{t()}catch(r){d(r,"cleanup unsubscribe")}}),delete e._jihoUnsubscribers),Array.from(e.children).forEach(t=>U(t))}function E(e,t){try{if(typeof e=="function"){const n=b(()=>e(t),`component ${e.name||"anonymous"}`);if(!n)return null;if(n.nodeType)return n;if(n.layout){const i=document.createElement("div");return i.style.display="contents",new T(i).update(n.layout),i}const[c,o]=Object.entries(n)[0];return E(c,o)}if(typeof t=="function"){const n=b(t,"options function");if(!n)return null;const[c,o]=Object.entries(n)[0];return E(c,o)}if(typeof t=="string"){const n=document.createElement(e);return n.textContent=t,n}if(typeof e!="string")return console.warn("JihoFrame: Tag must be a string, got:",typeof e),null;const r=document.createElement(e);return t&&(W(r,t,e),G(r,t)),r}catch(r){return d(r,`createElement for tag ${e}`),null}}function H(e,t){if(!Array.isArray(e)){console.warn("JihoFrame: Conditional block value must be an array");return}let r=document.createComment("condition-start"),n=document.createComment("condition-end"),c=null,o=[];t.appendChild(r),t.appendChild(n);const i=()=>{c&&(U(c),c.parentNode&&c.parentNode.removeChild(c),c=null),o.forEach(u=>{try{u()}catch(a){d(a,"conditional cleanup unsubscribe")}}),o=[]},s=()=>{try{t.contains(n)||(n=document.createComment("condition-end"),t.appendChild(n)),i();let u=!1;for(const a of e){if(!a||typeof a!="object"){console.warn("JihoFrame: Invalid conditional item");continue}const[f,m]=Object.entries(a)[0];if(!m||typeof m!="object")continue;const v=m.if??(u?!1:m.elseIf??m.else);if((typeof v=="function"?b(v,"conditional condition"):v)&&!u){const J=E(f,m);if(J&&t.contains(n)){t.insertBefore(J,n),c=J,u=!0;break}}}}catch(u){d(u,"conditional block rerender")}},l=j(s);return o.push(l),s(),i}function X(e,t){if(!e||typeof e!="object"){console.warn("JihoFrame: Switch block must be an object");return}let r=document.createComment("switch-start"),n=document.createComment("switch-end"),c=null,o=[];t.appendChild(r),t.appendChild(n);const i=()=>{c&&(U(c),c.parentNode&&c.parentNode.removeChild(c),c=null),o.forEach(u=>{try{u()}catch(a){d(a,"switch cleanup unsubscribe")}}),o=[]},s=()=>{try{t.contains(n)||(n=document.createComment("switch-end"),t.appendChild(n)),i();const u=typeof e.switch=="function"?b(e.switch,"switch value function"):e.switch;if(!Array.isArray(e.cases)){console.warn("JihoFrame: Switch cases must be an array");return}for(const a of e.cases)if(!(!a||typeof a!="object")&&(a.case===u||a.default===!0)&&a.element&&typeof a.element=="object"){const[f,m]=Object.entries(a.element)[0],v=E(f,m);if(v&&t.contains(n)){t.insertBefore(v,n),c=v;break}}}catch(u){d(u,"switch block rerender")}},l=j(s);return o.push(l),s(),i}class T{constructor(t){this.container=t,this.currentNodes=[],this.cleanupFunctions=[]}cleanup(){this.currentNodes.forEach(t=>{t&&t.parentNode&&(U(t),t.parentNode.removeChild(t))}),this.cleanupFunctions.forEach(t=>{try{t()}catch(r){d(r,"DOM updater cleanup")}}),this.currentNodes=[],this.cleanupFunctions=[]}update(t){if(this.cleanup(),!Array.isArray(t)){console.warn("JihoFrame: Layout must be an array");return}t.forEach((r,n)=>{try{if(typeof r=="function"){const c=b(r,`layout function at index ${n}`);if(c){const[o,i]=Object.entries(c)[0],s=E(o,i);s&&(this.container.appendChild(s),this.currentNodes.push(s))}}else if(r&&typeof r=="object"){const[c,o]=Object.entries(r)[0];if(c==="condition"&&Array.isArray(o)){const i=H(o,this.container);i&&this.cleanupFunctions.push(i)}else if(c==="switchBlock"){const i=X(o,this.container);i&&this.cleanupFunctions.push(i)}else{const i=E(c,o);i&&(this.container.appendChild(i),this.currentNodes.push(i))}}}catch(c){d(c,`rendering layout item at index ${n}`)}})}}function Y(e,t){if(typeof e!="function")throw new Error("JihoFrame: App must be a function");if(!t||!t.appendChild)throw new Error("JihoFrame: Container must be a valid DOM element");k.forEach(s=>{try{s()}catch(l){d(l,"init callback")}});const r=new T(t);let n=[];const c=()=>{try{const s=b(e,"app function");if(!s)return;if(!s.layout){console.warn("JihoFrame: App function must return an object with layout property");return}r.update(s.layout),x.forEach(l=>{try{l()}catch(u){d(u,"mount callback")}})}catch(s){d(s,"app rerender")}},o=j(c);n.push(o),c();const i=()=>{try{_.forEach(s=>{try{s()}catch(l){d(l,"unmount callback")}}),r.cleanup(),n.forEach(s=>{try{s()}catch(l){d(l,"app unsubscribe")}})}catch(s){d(s,"app cleanup")}};return window.addEventListener("beforeunload",i),i}h.combineStates=M,h.computedState=z,h.createState=$,h.getStateSnapshot=P,h.jihoInit=V,h.jihoMount=D,h.jihoUnMount=q,h.jihoUpdate=L,h.renderApp=Y,h.resetState=N,h.subscribeState=j,h.unsubscribeAll=K,h.watchState=R,Object.defineProperty(h,Symbol.toStringTag,{value:"Module"})});
